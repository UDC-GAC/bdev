#!/bin/sh

if [ $# -ne 1 ]; then
       echo "$0 node"
       exit -1
fi

NODE_IP=$1
FINAL_DIGIT=`echo $NODE_IP | cut -d "." -f 4`
ILO_IP="${ILO_BASE_IP}.${FINAL_DIGIT}"

echo -e "Time(s) Power(w) (node-${NODE_NUMBER}, IP: ${NODE_IP}, iLO IP: ${ILO_IP})"

BEGIN_EPOCH=`date +%s`
TARGET_EPOCH=$BEGIN_EPOCH

while true
do
	LOOP_EPOCH=`date +%s`
	TARGET_EPOCH=$(( $TARGET_EPOCH + $ILO_SECONDS_INTERVAL ))
	PRESENT_POWER_READINGS=""
	
	NODE_POWER_READINGS=`$ILO_CONFIG_SCRIPT -s $ILO_IP -f $ILO_POWER_SCRIPT`
	NODE_PRESENT_POWER_READING=`echo "$NODE_POWER_READINGS" | grep "PRESENT_POWER_READING"`
	NODE_PRESENT_POWER_READING=${NODE_PRESENT_POWER_READING##*<PRESENT_POWER_READING VALUE=\"}
	NODE_PRESENT_POWER_READING=${NODE_PRESENT_POWER_READING%\" UNIT=\"Watts\"/>*}
	PRESENT_POWER_READINGS="$PRESENT_POWER_READINGS $NODE_PRESENT_POWER_READING"

	CURRENT_EPOCH=`date +%s`
	SLEEP_SECONDS=$(( $TARGET_EPOCH - $CURRENT_EPOCH ))
	CURRENT_TIME=$(( $LOOP_EPOCH - $BEGIN_EPOCH ))
	echo -e "$CURRENT_TIME \t $PRESENT_POWER_READINGS"
	if [[ $SLEEP_SECONDS -gt 0 ]]
	then
		sleep $SLEEP_SECONDS
	fi
done
